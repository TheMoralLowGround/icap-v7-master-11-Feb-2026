server {
    listen       8080;
    server_name  localhost;

    add_header X-Frame-Options "DENY" always;
    add_header Content-Security-Policy "frame-ancestors 'none'" always;

    root /usr/share/nginx/html;

    # Explicitly prevent caching of index.html - always serve latest
    location = /index.html {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        try_files $uri =404;
    }

    # Prevent caching of non-hashed public assets - allows 304 responses
    location ~* ^/(loader\.css|favicon\.ico)$ {
        add_header Cache-Control "no-cache, must-revalidate" always;
        add_header Pragma "no-cache" always;
        etag on; # Ensures efficient 304 responses
        expires -1;
    }

    # Cache hashed JS and CSS files aggressively (they have contenthash in filename)
    # Safe to cache because filename changes when content changes
    # Excludes loader.css which is handled separately above
    location ~* ^/(?!loader\.css$).+\.(?:css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        access_log off;
    }

    # Cache other static assets for 1 year - safe because they should be content-hashed
    # If not content-hashed, consider adding hash to filenames or use shorter cache time
    # Excludes favicon.ico which is handled separately above
    location ~* ^/(?!favicon\.ico$).+\.(?:jpg|jpeg|gif|png|ico|svg|webp|woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        access_log off;
    }

    # Default location for SPA routing
    location / {
        try_files $uri $uri/ /index.html;
    }

    # redirect server error pages to the static page /50x.html - always serve latest
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    }
}